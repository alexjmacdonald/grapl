meta:
  project: grapl

#
# mounts
#

mount=dist:
  bind: dist/rust
  path: /home/grapl/target/debug/

mount=rust-Cargo-toml:
  bind: src/rust/Cargo.toml
  path: /home/grapl/Cargo.toml
  read-only: true

mount=rust-Cargo-lock:
  bind: src/rust/Cargo.lock
  path: /home/grapl/Cargo.lock
  read-only: true

mount=rust-analyzer-dispatcher:
  bind: src/rust/analyzer-dispatcher
  path: /home/grapl/analyzer-dispatcher
  read-only: true

mount=rust-derive-dynamic-node:
  bind: src/rust/derive-dynamic-node
  path: /home/grapl/derive-dynamic-node
  read-only: true

mount=rust-generic-subgraph-generator:
  bind: src/rust/generic-subgraph-generator
  path: /home/grapl/generic-subgraph-generator
  read-only: true

mount=rust-graph-descriptions:
  bind: src/rust/graph-descriptions
  path: /home/grapl/graph-descriptions
  read-only: true

mount=rust-graph-generator-lib:
  bind: src/rust/graph-generator-lib
  path: /home/grapl/graph-generator-lib
  read-only: true

mount=rust-graph-merger:
  bind: src/rust/graph-merger
  path: /home/grapl/graph-merger
  read-only: true

mount=rust-grapl-config:
  bind: src/rust/grapl-config
  path: /home/grapl/grapl-config
  read-only: true

mount=rust-grapl-observe:
  bind: src/rust/grapl-observe
  path: /home/grapl/grapl-observe
  read-only: true

mount=rust-metric-forwarder:
  bind: src/rust/metric-forwarder
  path: /home/grapl/metric-forwarder
  read-only: true

mount=rust-node-identifier:
  bind: src/rust/node-identifier
  path: /home/grapl/node-identifier
  read-only: true

mount=rust-sysmon-subgraph-generator:
  bind: src/rust/sysmon-subgraph-generator
  path: /home/grapl/sysmon-subgraph-generator
  read-only: true

mount=sccache:
  bind: ~/.cache/sccache
  path: /home/grapl/.cache/sccache

#
# images
#

# rust images

image=rust-build-image:
  image: grapl/grapl-rust-build-inickles
  context: src/rust
  dockerfile: Dockerfile.build
  args:
    release_target: "{env.GRAPL_RELEASE_TARGET:debug}"
  tags:
    - latest
  target: grapl-rust-base

job=rust-build:
  use: rust-build-image
  mounts: 
    - rust-Cargo-toml
    - rust-Cargo-lock
    - dist
    - sccache
    - rust-analyzer-dispatcher
    - rust-derive-dynamic-node
    - rust-generic-subgraph-generator
    - rust-graph-descriptions
    - rust-graph-generator-lib
    - rust-graph-merger
    - rust-grapl-config
    - rust-grapl-observe
    - rust-metric-forwarder
    - rust-node-identifier
    - rust-sysmon-subgraph-generator
  # net-mode: 'host'
  command: bash -c "cargo build && sccache -s"
  #command: bash -c "sccache -s"
  env:
          - "RUSTC_WRAPPER=/usr/bin/sccache"
  annotations:
    description: "Build Rust sources"
    #artifact:
          # - ./target/debug
          # - ./target/debug/analyzer-dispatcher
          # - ./target/debug/generic-subgraph-generator
          # - ./target/debug/graph-merger
          # - ./target/debug/metric-forwarder
          # - ./target/debug/node-identifier
          # - ./target/debug/node-identifier-retry-handler
          # - ./target/debug/sysmon-subgraph-generator

